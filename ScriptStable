#!/bin/bash
set -e

echo "=== Cài đặt Stable Node tự động ==="
echo "User thực: $(logname)"
echo ""

# ===== NHẬP TÊN NODE =====
read -p "Nhập tên node (moniker) bạn muốn đặt [default: NamasStable]: " MONIKER
if [ -z "$MONIKER" ]; then
    MONIKER="NamasStable"
fi

echo "Tên node sẽ sử dụng: $MONIKER"
echo ""

# ===== CÀI DEPENDENCIES =====
sudo apt update
sudo apt install -y wget tar jq lz4 ca-certificates

# ===== TẠO THƯ MỤC CẦN THIẾT =====
sudo mkdir -p /home/$(logname)/stable
sudo mkdir -p /home/$(logname)/downloads
sudo chown -R $(logname):$(logname) /home/$(logname)

cd /home/$(logname)/stable

# ====== XÓA .stabled CŨ ĐỂ TRÁNH LỖI INIT ======
sudo rm -rf /home/$(logname)/stable/.stabled

# ===== TẢI BINARY STABLED =====
wget -O stabled.tar.gz "https://stable-testnet-data.s3.us-east-1.amazonaws.com/stabled-1.1.1-linux-amd64-testnet.tar.gz"
tar -xzf stabled.tar.gz

sudo cp stabled /usr/bin/stabled
sudo chmod +x /usr/bin/stabled

# ===== INIT NODE =====
sudo -u $(logname) stabled init "$MONIKER" \
    --home /home/$(logname)/stable/.stabled \
    --chain-id stabletestnet_2201-1

# ===== TẢI GENESIS TỪ GITHUB =====
echo "=== Tải genesis từ GitHub ==="

wget -O /home/$(logname)/downloads/genesis.json \
https://raw.githubusercontent.com/Namas1012/Stable/refs/heads/main/genesis.json

if [ ! -s /home/$(logname)/downloads/genesis.json ]; then
    echo "LỖI: Không tải được genesis.json!"
    exit 1
fi

sudo mkdir -p /home/$(logname)/stable/.stabled/config
sudo chown -R $(logname):$(logname) /home/$(logname)/stable/.stabled

# Backup genesis cũ nếu có
if [ -f /home/$(logname)/stable/.stabled/config/genesis.json ]; then
    sudo cp /home/$(logname)/stable/.stabled/config/genesis.json \
        /home/$(logname)/stable/.stabled/config/genesis.json.bak.$(date +%s)
fi

sudo cp /home/$(logname)/downloads/genesis.json \
    /home/$(logname)/stable/.stabled/config/genesis.json

sudo chown $(logname):$(logname) \
    /home/$(logname)/stable/.stabled/config/genesis.json

sudo chmod 644 /home/$(logname)/stable/.stabled/config/genesis.json

echo "Genesis đã cài đặt!"
echo ""

# ===== TẢI app.toml & config.toml =====
echo "=== Tải app.toml & config.toml từ GitHub ==="

wget -q -O /home/$(logname)/stable/.stabled/config/app.toml \
https://raw.githubusercontent.com/Namas1012/Stable/refs/heads/main/app.toml

wget -q -O /home/$(logname)/stable/.stabled/config/config.toml \
https://raw.githubusercontent.com/Namas1012/Stable/refs/heads/main/config.toml

sudo chown $(logname):$(logname) \
    /home/$(logname)/stable/.stabled/config/app.toml \
    /home/$(logname)/stable/.stabled/config/config.toml

echo "Cấu hình đã cập nhật!"
echo ""

# ===== SNAPSHOT =====
echo "=== Tải snapshot ==="

wget -O /home/$(logname)/stable/snapshot.tar.lz4 \
"https://stable-snapshot.s3.eu-central-1.amazonaws.com/snapshot.tar.lz4" \
|| { echo "Snapshot download failed"; exit 1; }

sudo systemctl stop stabled 2>/dev/null || true

# Xóa data cũ
sudo rm -rf /home/$(logname)/stable/.stabled/data

echo "=== Giải nén snapshot đúng chuẩn ==="
sudo -u $(logname) bash -c \
"lz4 -dc /home/$(logname)/stable/snapshot.tar.lz4 | tar -x -C /home/$(logname)/stable/.stabled"

# Tạo priv_validator_state.json nếu snapshot không có
if [ ! -f /home/$(logname)/stable/.stabled/data/priv_validator_state.json ]; then
    echo "Tạo priv_validator_state.json..."
    echo '{"height":"0","round":0,"step":0}' \
    | sudo tee /home/$(logname)/stable/.stabled/data/priv_validator_state.json > /dev/null
    sudo chown $(logname):$(logname) /home/$(logname)/stable/.stabled/data/priv_validator_state.json
fi

sudo chown -R $(logname):$(logname) /home/$(logname)/stable

# ===== MỞ PORT =====
sudo apt install ufw -y
sudo ufw allow 26656/tcp
sudo ufw allow 26657/tcp

# ===== TẠO SYSTEMD SERVICE =====
echo "=== Tạo service stabled ==="

sudo tee /etc/systemd/system/stabled.service > /dev/null <<EOF
[Unit]
Description=Stable Daemon Service
After=network-online.target

[Service]
User=$(logname)
WorkingDirectory=/home/$(logname)/stable
ExecStart=/usr/bin/stabled start --home /home/$(logname)/stable/.stabled --chain-id stabletestnet_2201-1
Restart=always
RestartSec=3
LimitNOFILE=65535
StandardOutput=journal
StandardError=journal
SyslogIdentifier=stabled

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl daemon-reload
sudo systemctl enable stabled
sudo systemctl start stabled

echo ""
echo "=== CÀI ĐẶT HOÀN TẤT! ==="
echo "Xem log realtime:"
echo "  sudo journalctl -u stabled -f"
echo ""
